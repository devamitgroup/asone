<!DOCTYPE html>
<html lang="vi">
<%- include('../../partials/head', { title: title }) %>
<body>
    <%- include('../../partials/header') %>

    <div class="navi">
        <div class="w-ct padding15">
            <a href="/">Trang chủ</a><span>/</span>
            <span>Tất cả sản phẩm</span>
        </div>
    </div>

    <div class="w-ct padding15 clearfix">
        <div class="row">
            <div class="col-md-3 col-sm-4 hidden-xs">
                <div class="sidebar-filter">
                    <div class="ltitle1">Hãng sản xuất</div>
                    <div id="manufacturer-filters" class="filter-list">
                        <!-- Dynamic manufacturers -->
                    </div>
                </div>
            </div>
            <div class="col-md-9 col-sm-8 col-xs-12">
                <h1 class="htitle2">Sản phẩm</h1>
                <div class="row" id="product-list">
                    <!-- Products will be loaded here via JS -->
                    <div class="col-xs-12 loading-msg text-center">Đang tải sản phẩm...</div>
                </div>

                <div class="pagination-container text-center">
                    <ul class="pagination-modern" id="pagination"></ul>
                </div>
            </div>
        </div>
    </div>

    <%- include('../../partials/footer') %>
    <%- include('../../partials/social_ring') %>
    <%- include('../../partials/scripts') %>

    <script>
        (async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const productList = document.querySelector('#product-list');
            const pagination = document.querySelector('#pagination');
            const filterBox = document.querySelector('#manufacturer-filters');

            // 1. Load Manufacturers
            const resM = await fetch('/hang-san-xuat/');
            const manufacturers = await resM.json();
            const activeManufacturers = urlParams.get('manufacturers')?.split(',') || [];

            if (manufacturers && filterBox) {
                filterBox.innerHTML = '';
                manufacturers.forEach(m => {
                    const checked = activeManufacturers.includes(m._id) ? 'checked' : '';
                    filterBox.innerHTML += `
                        <div class="filter-item">
                            <label>
                                <input type="checkbox" value="${m._id}" ${checked} class="m-filter-checkbox">
                                ${m.name}
                            </label>
                        </div>
                    `;
                });

                // Attach filter events
                document.querySelectorAll('.m-filter-checkbox').forEach(cb => {
                    cb.addEventListener('change', () => {
                        const selected = Array.from(document.querySelectorAll('.m-filter-checkbox:checked')).map(i => i.value);
                        if (selected.length > 0) {
                            urlParams.set('manufacturers', selected.join(','));
                        } else {
                            urlParams.delete('manufacturers');
                        }
                        urlParams.set('page', '1');
                        window.location.search = urlParams.toString();
                    });
                });
            }

            // 2. Load Products
            const page = urlParams.get('page') || 1;
            const manId = urlParams.get('manufacturers') || '';
            const fetchUrl = `/san-pham/?page=${page}&limit=36${manId ? `&manufacturerId=${manId}` : ''}`;
            
            try {
                const resP = await fetch(fetchUrl);
                const data = await resP.json();

                if (data && data.products && data.products.length > 0) {
                    productList.innerHTML = '';
                    data.products.forEach(product => {
                        productList.innerHTML += `
                            <div class="col-md-4 col-sm-6 col-xs-6">
                                <div class="p-i">
                                    <a class="p-img" href="/san-pham/${product.slug}">
                                        <img src="${product.images[0]}" alt="${product.name}" />
                                    </a>
                                    <h3><a href="/san-pham/${product.slug}">${product.name}</a></h3>
                                    <p class="price-box"><span class="price-news">Giá: Liên hệ</span></p>
                                </div>
                            </div>
                        `;
                    });

                    // Pagination
                    pagination.innerHTML = '';
                    const totalPages = data.totalPages;
                    for (let i = 1; i <= totalPages; i++) {
                        const active = i == page ? 'active' : '';
                        const pLinkParams = new URLSearchParams(urlParams.toString());
                        pLinkParams.set('page', i);
                        pagination.innerHTML += `<li class="${active}"><a href="?${pLinkParams.toString()}">${i}</a></li>`;
                    }
                } else {
                    productList.innerHTML = '<div class="col-xs-12">Không tìm thấy sản phẩm nào.</div>';
                    pagination.innerHTML = '';
                }
            } catch (err) {
                console.error('Error fetching products:', err);
                productList.innerHTML = '<div class="col-xs-12">Lỗi khi tải danh sách sản phẩm.</div>';
            }
        })();
    </script>
</body>
</html>
