<!DOCTYPE html>
<html lang="vi">
<%- include('../../partials/head', { title: title }) %>
<body>
    <%- include('../../partials/header') %>

    <div class="navi">
        <div class="w-ct padding15">
            <a href="/">Trang chủ</a><span>/</span>
            <span>Danh mục</span>
        </div>
    </div>

    <div class="w-ct clearfix lstproduct padding15">
        <div class="col-md-3 col-sm-3 hidden-xs">
            <div class="ltitle1">Lọc sản phẩm</div>
            <div class="attributelist">
                <p>Thương hiệu</p>
                <ul class='groupattr1'></ul>
            </div>
        </div>
        <div class="col-md-9 col-sm-9 col-xs-12">
            <div id="listproduct" class="row">
                <div class="col-xs-12 text-center">Đang tải sản phẩm...</div>
            </div>
            <div id="pagination" class="pagination-modern"></div>
        </div>
    </div>

    <%- include('../../partials/footer') %>
    <%- include('../../partials/social_ring') %>
    <%- include('../../partials/scripts') %>

    <script>
        (async () => {
            const categoryId = '<%= categoryId %>';
            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get('page')) || 1;
            const manufacturerIds = params.getAll('manufacturerId');

            // Load Manufacturers for filter
            const resBrandsList = await fetch('/hang-san-xuat/');
            const brandsData = await resBrandsList.json();
            const groupattr1 = document.querySelector('.groupattr1');
            if (brandsData && groupattr1) {
                brandsData.forEach(brand => {
                    const isChecked = manufacturerIds.includes(brand._id) ? 'checked' : '';
                    groupattr1.innerHTML += `
                        <li>
                            <label>
                                <input class='chkattribute' type='checkbox' value='${brand._id}' ${isChecked} />
                                ${brand.name}
                            </label>
                        </li>
                    `;
                });
                
                document.querySelectorAll('.chkattribute').forEach(cb => {
                    cb.onchange = () => {
                        const checkedIds = Array.from(document.querySelectorAll('.chkattribute:checked')).map(c => c.value);
                        const newParams = new URLSearchParams();
                        checkedIds.forEach(id => newParams.append('manufacturerId', id));
                        window.location.href = `${window.location.pathname}?${newParams.toString()}`;
                    };
                });
            }

            // Load Products
            let requestUrl = `/san-pham/get-by-parent-category/${categoryId}?page=${page}`;
            manufacturerIds.forEach(id => requestUrl += `&manufacturerId=${id}`);

            const resProd = await fetch(requestUrl);
            const data = await resProd.json();
            const listproduct = document.querySelector('#listproduct');
            const pagination = document.querySelector('#pagination');

            if (data && data.products.length) {
                listproduct.innerHTML = '';
                data.products.forEach(product => {
                    listproduct.innerHTML += `
                        <div class="col-md-3 col-sm-4 col-xs-6">
                            <div class="p-i">
                                <a class="p-img" href="/san-pham/${product.slug}">
                                    <img src="/${product.images[0]}" alt="${product.name}">
                                </a>
                                <h3><a href="/san-pham/${product.slug}">${product.name}</a></h3>
                                <p class="price-box"><span class="price-news">Giá: Liên hệ</span></p>
                            </div>
                        </div>
                    `;
                });

                // Pagination logic
                if (data.totalPages > 1) {
                    for (let i = 1; i <= data.totalPages; i++) {
                        const pageLink = document.createElement('a');
                        pageLink.href = `?page=${i}`;
                        manufacturerIds.forEach(id => pageLink.href += `&manufacturerId=${id}`);
                        pageLink.innerText = i;
                        if (i === page) pageLink.className = 'active';
                        pagination.appendChild(pageLink);
                    }
                }
            } else {
                listproduct.innerHTML = '<p class="text-center">Không tìm thấy sản phẩm nào.</p>';
            }
        })();
    </script>
</body>
</html>
