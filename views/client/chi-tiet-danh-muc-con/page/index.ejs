<!DOCTYPE html>
<html lang="vi">
<%- include('../../partials/head', { title: title }) %>
<body>
    <%- include('../../partials/header') %>

    <div class="navi">
        <div class="w-ct padding15">
            <a href="/">Trang chủ</a><span>/</span>
            <span>Danh mục con</span>
        </div>
    </div>

    <div class="w-ct clearfix lstproduct padding15">
        <div class="col-md-3 col-sm-3 hidden-xs">
            <div class="ltitle1">Lọc sản phẩm</div>
            <div class="attributelist">
                <p>Thương hiệu</p>
                <ul class='groupattr1'></ul>
            </div>
        </div>
        <div class="col-md-9 col-sm-9 col-xs-12">
            <div id="listproduct" class="row">
                <div class="col-xs-12 text-center">Đang tải sản phẩm...</div>
            </div>
            <div id="pagination" class="pagination-modern"></div>
        </div>
    </div>

    <%- include('../../partials/footer') %>
    <%- include('../../partials/social_ring') %>
    <%- include('../../partials/scripts') %>

    <script>
        (async () => {
            const subcategoryId = '<%= subcategoryId %>';
            const params = new URLSearchParams(window.location.search);
            const page = parseInt(params.get('page')) || 1;
            const manufacturerIds = params.getAll('manufacturerId');

            // Load Manufacturers
            const resBrands = await fetch('/hang-san-xuat/');
            const brands = await resBrands.json();
            const groupattr1 = document.querySelector('.groupattr1');
            if (brands && groupattr1) {
                brands.forEach(brand => {
                    const isChecked = manufacturerIds.includes(brand._id) ? 'checked' : '';
                    groupattr1.innerHTML += `
                        <li>
                            <label>
                                <input class='chkattribute' type='checkbox' value='${brand._id}' ${isChecked} />
                                ${brand.name}
                            </label>
                        </li>
                    `;
                });
                document.querySelectorAll('.chkattribute').forEach(cb => {
                    cb.onchange = () => {
                        const checked = Array.from(document.querySelectorAll('.chkattribute:checked')).map(c => c.value);
                        const newP = new URLSearchParams();
                        checked.forEach(id => newP.append('manufacturerId', id));
                        window.location.href = `${window.location.pathname}?${newP.toString()}`;
                    };
                });
            }

            // Load Products
            let url = `/san-pham/get-by-category/${subcategoryId}?page=${page}`;
            manufacturerIds.forEach(id => url += `&manufacturerId=${id}`);

            const resP = await fetch(url);
            const data = await resP.json();
            const list = document.querySelector('#listproduct');
            const pagin = document.querySelector('#pagination');

            if (data && data.products.length) {
                list.innerHTML = '';
                data.products.forEach(p => {
                    list.innerHTML += `
                        <div class="col-md-3 col-sm-4 col-xs-6">
                            <div class="p-i">
                                <a class="p-img" href="/san-pham/${p.slug}">
                                    <img src="/${p.images[0]}" alt="${p.name}">
                                </a>
                                <h3><a href="/san-pham/${p.slug}">${p.name}</a></h3>
                                <p class="price-box"><span class="price-news">Giá: Liên hệ</span></p>
                            </div>
                        </div>
                    `;
                });

                if (data.totalPages > 1) {
                    for (let i = 1; i <= data.totalPages; i++) {
                        const a = document.createElement('a');
                        a.href = `?page=${i}`;
                        manufacturerIds.forEach(id => a.href += `&manufacturerId=${id}`);
                        a.innerText = i;
                        if (i === page) a.className = 'active';
                        pagin.appendChild(a);
                    }
                }
            } else {
                list.innerHTML = '<p class="text-center">Không tìm thấy sản phẩm nào.</p>';
            }
        })();
    </script>
</body>
</html>
